name: Build
on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  macos_analyzers:
    runs-on: macos-latest
    name: macOS Analyzers Build
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/heads/branch-') || startsWith(github.ref, 'refs/heads/dogfood-')
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add x86_64-apple-darwin
      - name: Build Rust analyzers
        run: |
          echo "org.gradle.daemon=false" >> "gradle.properties"
          echo "org.gradle.vfs.watch=false" >> "gradle.properties"
          source $HOME/.cargo/env
          gradle :analyzer:compileRustDarwin :analyzer:compileRustDarwinX86 --info --stacktrace
      - name: Upload Darwin ARM64 artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: analyzer-aarch64-apple-darwin
          path: analyzer/target/aarch64-apple-darwin/release/analyzer.xz
      - name: Upload Darwin x86_64 artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: analyzer-x86_64-apple-darwin
          path: analyzer/target/x86_64-apple-darwin/release/analyzer.xz

  cross_platform_analyzers:
    runs-on: github-ubuntu-latest-m
    name: Cross-Platform Analyzers Build
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install autoconf build-essential gcc-mingw-w64 git libtool musl-dev musl-tools pkg-config rustup
          sudo apt-get clean
      - name: Cache cross-compiler
        id: cache-cross-compiler
        env:
          MUSL_CROSS_MAKE_COMMIT: 6f3701d08137496d5aac479e3a3977b5ae993c1f
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: cross-compiler-output
          key: musl-cross-compiler-aarch64-${{ env.MUSL_CROSS_MAKE_COMMIT }}
      - name: Build cross-compiler
        if: steps.cache-cross-compiler.outputs.cache-hit != 'true'
        env:
          MUSL_CROSS_MAKE_COMMIT: 6f3701d08137496d5aac479e3a3977b5ae993c1f
        run: |
          # Build aarch64-linux-musl cross-compiler
          # This approach is based on https://github.com/cross-rs/cross/blob/main/docker/musl.sh
          git clone https://github.com/richfelker/musl-cross-make.git
          cd musl-cross-make
          # we checkout a specific commit to guarantee reproducibility (tags can be moved)
          git checkout $MUSL_CROSS_MAKE_COMMIT
          echo -e "TARGET = aarch64-linux-musl\nOUTPUT = $PWD/../cross-compiler-output\n" >> config.mak
          make
          make install
          cd ..
      - name: Install cross-compiler
        run: |
          # Install cross-compiler to system location
          sudo cp -r cross-compiler-output/* /usr/local/
      - name: Setup Rust toolchain
        run: |
          # Setup Rust toolchain
          rustup default 1.91.1
          rustup component add llvm-tools rustfmt clippy
          cargo install cargo-llvm-cov
          
          # Add target platforms
          rustup target add x86_64-pc-windows-gnu
          rustup target add x86_64-unknown-linux-musl
          rustup target add x86_64-unknown-linux-gnu
          rustup target add aarch64-unknown-linux-musl
      - name: Build Rust analyzers
        run: |
          gradle :analyzer:compileRustLinuxMusl :analyzer:compileRustLinuxArm :analyzer:compileRustWin --info --stacktrace
      - name: Upload Linux x86_64 analyzer
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: analyzer-x86_64-unknown-linux-musl
          path: analyzer/target/x86_64-unknown-linux-musl/release/analyzer.xz
      - name: Upload Linux ARM64 analyzer
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: analyzer-aarch64-unknown-linux-musl
          path: analyzer/target/aarch64-unknown-linux-musl/release/analyzer.xz
      - name: Upload Windows analyzer
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: analyzer-x86_64-pc-windows-gnu
          path: analyzer/target/x86_64-pc-windows-gnu/release/analyzer.exe.xz

  unit_test_and_analysis:
    runs-on: github-ubuntu-latest-m
    name: Unit Tests and Analysis
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      - name: Setup Rust toolchain
        run: |
          sudo apt-get update
          sudo apt-get -y install rustup musl-tools
          sudo apt-get clean

          # Setup Rust toolchain (default target only)
          rustup default 1.91.1
          rustup component add llvm-tools rustfmt clippy
          rustup target add x86_64-unknown-linux-musl
          cargo install cargo-llvm-cov
      - uses: SonarSource/ci-github-actions/config-gradle@v1
      - uses: SonarSource/ci-github-actions/build-gradle@v1
        with:
          deploy: false
          deploy-pull-request: false
          gradle-args: "-PskipCrossCompile --info --stacktrace"

  build:
    needs: [macos_analyzers, cross_platform_analyzers]
    if: '!cancelled()'
    runs-on: github-ubuntu-latest-m
    name: Build
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      # Download Darwin artifacts (only if macos_analyzers job succeeded)
      - name: Download Darwin ARM64 artifact
        if: needs.macos_analyzers.result == 'success'
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: analyzer-aarch64-apple-darwin
          path: analyzer/target/aarch64-apple-darwin/release/
      - name: Download Darwin x86_64 artifact
        if: needs.macos_analyzers.result == 'success'
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: analyzer-x86_64-apple-darwin
          path: analyzer/target/x86_64-apple-darwin/release/
      # Download Linux/Windows artifacts (always built)
      - name: Download Linux x86_64 analyzer
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: analyzer-x86_64-unknown-linux-musl
          path: analyzer/target/x86_64-unknown-linux-musl/release/
      - name: Download Linux ARM64 analyzer
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: analyzer-aarch64-unknown-linux-musl
          path: analyzer/target/aarch64-unknown-linux-musl/release/
      - name: Download Windows analyzer
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: analyzer-x86_64-pc-windows-gnu
          path: analyzer/target/x86_64-pc-windows-gnu/release/      
      - uses: SonarSource/ci-github-actions/build-gradle@v1
        with:
          deploy-pull-request: true
          gradle-args: "-PskipAnalyzerBuild --info --stacktrace"
          sonar-platform: 'none' # skip SQ analysis, it's done in analysis job
          skip-tests: true

  e2e:
    needs: [build]
    if: ${{ !cancelled() && needs.build.result == 'success' }}
    runs-on: github-ubuntu-latest-s
    name: E2E Tests
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      - name: Vault
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/github/token/licenses-ro token | GITHUB_TOKEN;
      - uses: SonarSource/ci-github-actions/config-gradle@v1
      - name: Run E2E tests
        env:
          GITHUB_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).GITHUB_TOKEN }}
        run: |
          gradle :e2e:test -Pe2e -DpluginVersion=${PROJECT_VERSION} --info --stacktrace

  e2e_win:
    needs: [build]
    if: ${{ !cancelled() && needs.build.result == 'success' }}
    runs-on: github-windows-latest-s
    name: E2E Tests Windows
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      - name: Vault
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/github/token/licenses-ro token | GITHUB_TOKEN;
      - name: Install Rust
        run: |
          curl -O https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe
          ./rustup-init.exe -y --default-host x86_64-pc-windows-msvc --default-toolchain stable --profile minimal
          $env:PATH += ";$env:USERPROFILE\.cargo\bin"
          rustup component add clippy
      - uses: SonarSource/ci-github-actions/config-gradle@v1
      - name: Run E2E tests
        shell: bash
        env:
          GITHUB_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).GITHUB_TOKEN }}
        run: |
          echo "org.gradle.daemon=false" >> "gradle.properties"
          export PATH=$PATH:$HOME/.cargo/bin          
          gradle :e2e:test -Pe2e -DpluginVersion=${PROJECT_VERSION} --info --stacktrace
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: e2e-test-reports-windows
          path: e2e/build/reports/tests/**

  e2e_linux_arm64:
    needs: [build]
    if: ${{ !cancelled() && needs.build.result == 'success' }}
    runs-on: github-ubuntu-24.04-arm-s
    name: E2E Tests Linux ARM64
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3.2.0
        with:
          version: 2025.7.12
      - name: Vault
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/github/token/licenses-ro token | GITHUB_TOKEN;
      - uses: SonarSource/ci-github-actions/config-gradle@v1
      - name: Run E2E tests in ARM64 container
        env:
          GITHUB_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).GITHUB_TOKEN }}
        run: |
            echo 'org.gradle.daemon=false' >> gradle.properties
            export PATH=\$PATH:\$HOME/.cargo/bin
            gradle :e2e:test -Pe2e -DpluginVersion=\${PROJECT_VERSION} --info --stacktrace            
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: e2e-test-reports-linux-arm64
          path: e2e/build/reports/tests/**

  promote:
    needs: [build, unit_test_and_analysis, e2e, e2e_win, e2e_linux_arm64]
    runs-on: sonar-xs
    name: Promote
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/heads/branch-') || startsWith(github.ref, 'refs/heads/dogfood-')
    permissions:
      id-token: write
    steps:      
      - uses: SonarSource/ci-github-actions/promote@v1
        with:
          promote-pull-request: true
